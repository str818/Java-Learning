* [一、计算机网络概述](#一计算机网络概述)
    * [计算机网络](#计算机网络)
    * [因特网](#因特网)
    * [网络协议](#网络协议)
    * [网络的组成](#网络的组成)
    * [数据交换](#数据交换)
    * [多路复用](#多路复用)
    * [性能指标](#性能指标)
    * [体系结构](#体系结构)
    * [专业术语](#专业术语)
* [二、应用层](#二应用层)
    * [网络应用的体系结构](#网络应用的体系结构)
    * [网络应用的进程通信](#网络应用的进程通信)
    * [Internet 提供的传输服务](#Internet-提供的传输服务)
    * [Web](#Web)
    * [Email 应用](#Email-应用)
    * [DNS 域名系统](#DNS-域名系统)
    * [远程登录](#远程登录)
* [三、传输层](#三传输层)
    * [概述](#传输层概述)
    * [多路复用与多路分用](#多路复用与多路分用)
    * [UDP](#UDP)
    * [可靠数据传输原理](#可靠数据传输原理)
    * [TCP](#TCP)
    * [TCP 流量控制](#TCP-流量控制)
    * [TCP 拥塞控制](#TCP-拥塞控制)
* [四、网络层](#四网络层)
    * [概述](#网络层概述)
    * [IP 协议](#IP-协议)
    * [子网划分](#子网划分)
    * [DHCP 协议](#DHCP-协议)
    * [NAT 网络地址转换](#NAT-网络地址转换)

* [参考内容](#参考内容)

# 一、计算机网络概述

## 计算机网络

**计算机网络** 是 **互连** 的（互联互通）、 **自治** 的（无主从关系）计算机集合。

当网络中的主机距离很远、数量很大的时候，如何保证互连？

**答**： 通过交换网络互连主机。

<div align="center">  <img src="./pic/n1.png" width="60%"/> </div><br>

## 因特网

**因特网** 是一个世界范围的计算机网络，是一个互连了遍及全世界数十亿计算设备的网络。

最大的计算机网络就是因特网，它由非常多的计算机网络通过许多路由器互连而成，因此因特网也成为「网络的网络」。

## 网络协议

**网络协议** (network protocol)，简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定。

协议定义了两个或多个通信实体之间交换的报文的格式、意义和顺序，以及报文发送和/或接收一条报文或其他事件所采取的动作。

**协议三要素：**

- **语法**：用来规定信息格式、数据及控制信息的格式、编码及信号电平等。
- **语义**：用来说明通信双方应当怎么做，用于协调与差错处理的控制信息。
- **时序**：定义了何时进行通信，先讲什么，后讲什么，讲话的速度等。

## 网络的组成

计算机网络可分为 网络边缘、接入网络 与 网络核心。

### 1、网络边缘

主机（端系统）位于网络边缘，运行网络应用程序，网络应用程序之间的通信方式主要分为两类。

- 客户/服务器（C/S）应用模型：客服发送请求，接收服务器响应。
- 对等（P2P）应用模型：无专用服务器，通信在对等实体之间直接进行。

### 2、接入网络

接入网络是指将端系统物理连接到其边缘路由器的网络，边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器。接入网络需要解决的问题就是如何将网络边缘接入核心网（边缘路由器）。 

### 3、网络核心

网络核心的关键功能：**路由** + **转发** ，解决的基本问题是如何实现数据从源主机通过网络核心送达目的主机？答：数据交换。

## 数据交换

数据交换分为电路交换、报文交换与分组交换。

### 1、电路交换

电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终占用该链路。由于通信过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低。

### 2、报文交换

以报文为数据交换的单位，报文携带有目标地址、源地址等信息。

### 3、分组交换

每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。

在一个邮局通信系统中，邮局收到一份邮件之后，先存储下来，然后把相同目的地的邮件一起转发到下一个目的地，这个过程就是存储转发过程，分组交换也使用了存储转发过程。

报文交换与分组交换均采用存储-转发的交换方式

- 报文交换以完整报文进行「存储-转发」，需要中间结点有较大的缓存
- 分组交换以较小的分组进行「存储-转发」，并行发送，时间较快

适用于突发数据传输网络，资源充分共享，简单、无需呼叫建立，但是也可能产生拥塞，分组延迟和丢失，需要协议处理可靠数据传输和拥塞控制。

## 多路复用

多路复用表示在一个信道上传输多路信号或数据流的过程和技术，可根据使用的技术分为下面几类。

### 1、频分复用

频分复用（FDM）将信道资源在频率上进行划分，所有主机在相同的时间占用不同的频率带宽资源。

<div align="center">  <img src="./pic/FDM.png" width="50%"/> </div><br>

### 2、时分复用

时分复用（TDM）将时间划分为一段等长的时分复用帧（TDM帧），每个用户在每个 TDM 帧中占用固定序号的时隙，所有主机在不同的时间占用相同的频率带宽资源。

<div align="center">  <img src="./pic/TDM.png" width="60%"/> </div><br>

使用频分复用和时分复用进行通信，在通信的过程中主机会一直占用一部分信道资源。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。

### 3、波分复用

波分复用（WDM）光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。

<div align="center">  <img src="./pic/WDM.png" width="60%"/> </div><br>

### 4、码分复用

码分复用（CDM）采用扩频通信技术，各个低速信道可以在同一个地方使用相同的频率进行通信，不同的低速信道通过采用不同的地址码复用整个频段。

每个用户分配一个唯一的 m bit 码片序列，其中 0 用 -1 表示，1 用 +1 表示。各用户使用相同频率载波，利用各自码片序列编码数据。

编码信号 = 原始数据 × 码片序列

- 发送比特 1 (+1)，则发送自己的 m bit 码片序列
- 发送比特 0 (-1)，则发送该码片序列的 m bit 码片序列的反码

各用户的码片序列相互正交

<div align="center">  <img src="./pic/CDM1.png" width="50%"/> </div><br>

解码：码片序列与编码信号的內积，若结果为 1 表示发送的是 1 ； 若结果为 -1 表示发送的是 0 ；若结果为 0 ，表示此时间段，没有发送消息。

<div align="center">  <img src="./pic/CDM2.png" width="30%"/> </div><br>

码分复用需要发送的数据量为原先的 m 倍。

<div align="center">  <img src="./pic/CDM3.png" width="70%"/> </div><br>

## 性能指标

### 1、速率

「速率」即数据率或数据传输速率或比特率，表示单位时间（秒）传输的信息（比特）量。

单位： b/s（bps）、kb/s、Mb/s、Gb/s

速率往往是指 **额定速率** 或 **标称速率** 。

### 2、带宽

「带宽」原本指信号具有的频带宽度，即最高频率与最低频率之差，单位是赫兹（Hz）。

网络的「带宽」通常是数字信道所能传送的「最高数据率」，单位是 b/s（bps）。

### 3、时延

**问题：** 分组交换为什么会发生丢包和时延？

**答：** 分组在路由器缓存中排队，等待输出链路可用

#### 节点处理时延

主机或路由器收到分组时进行处理所需要的时间，差错检测，确定输出链路，通常时间小于毫秒。

#### 排队时延

等待输出立案率可用，取决于路由器的拥塞程度。

#### 传输时延

主机或路由器传输数据帧所需要的时间。

L：分组长度（bits）R：链路带宽（bps）传输时延 = L/R

#### 传播时延

电磁波在信道中传播所需要花费的时间。

d：物理链路长度 s：信号传播速度 传播时延 = d/s

### 4、吞吐量

「吞吐量」表示在发送端与接收端之间传送数据速率（b/s），可分为即时吞吐量与平均吞吐量。

* 即时吞吐量：给定时刻的速率
* 平均吞吐量：一段时间的平均速率

### 5、时延带宽积

「时延带宽积」是链路的带宽（bps）与传播时延的乘积，结果为比特的数据量，表示在特定时间该网络的最大数据量。

## 体系结构

<div align="center">  <img src="./pic/Struct1.png" width="70%"/> </div><br>

### 1、五层协议

* **应用层**：为应用程序提供服务并规定应用程序中通信相关的细节。包括文件传输、电子邮件、远程登录等协议。数据单位为报文。
* **传输层** ：为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。
* **网络层** ：为主机提供数据传输服务。而传输层协议是为主机中的进程提供数据传输服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。
* **数据链路层** ：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
* **物理层** ：负责 0、1 比特流与电压的高低、光的闪灭之间的转换，尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

### 2. OSI

其中表示层和会话层用途如下：

- **表示层** ：将应用处理的信息转换为适合网络传输的格式。设备固有数据格式和网络标准数据格式的转换。
- **会话层** ：负责建立和断开通信连接，以及数据的风格等数据传输相关的管理。

五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

### 3. TCP/IP

它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。

TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。

## 专业术语

1、RTT

一个短分组从客户到服务器然后再返回客户所花费的时间。

2、ISP（Internet Service Provider）

因特网服务提供商。

3、IXP（Internet eXchange Point）

互联网交换点 IXP 的主要作用就是允许两个网络直接相连并交换分组，不需要再通过第三个网络来转发分组。

# 二、应用层

## 网络应用的体系结构

* 客户机/服务器结构（Client-Server,C/S）：该结构中有一个总是打开的主机成为服务器，它服务于来自许多其他成为客户的主机的请求。一个典型的例子是 Web 应用程序。

* 点对点结构（Peer-to-Peer，P2P）：没有永远在线的服务器，任意端系统/节点之间可以直接通讯

* 混合结构（Hybrid）

## 网络应用的进程通信

同一主机上运行的进程之间可以由操作系统提供的进行间通信机制进行通信，而不同主机上运行的进程通过消息交换实现通信。在 C/S 结构中，客户机进程时发起通信的进程；服务器进程是等待通信请求的进程。

进程通过 **套接字（socket）** 的软件接口向网路发送报文和从网路接收报文。

为了标识接收进程，需要定义两种信息：主机地址（IP地址）与在目的主机中指定接收进程的标识符（端口号）。

## Internet 提供的传输服务

* TCP 服务：面向连接，具有可靠的传输、流量控制、拥塞控制，不提供时间/延迟与最小带宽保障。

* UDP 服务：无连接，不可靠的数据传输，不提供流量控制、拥塞控制、延迟保障与带宽保障。

## Web

万维网（WWW，World Wide Web）是将互联网中的信息以超文本形式展现的系统，也叫做Web。

**URL** （统一资源定位器）用于标识资源。

### 1、HTTP

Web 应用遵循 HTTP 协议（超文本传输协议），HTTP 使用 TCP 传输服务，是一个无状态协议，默认端口号是 80 。

##### （1）非持续连接与持续连接

HTTP 既能够使用非持续连接，也能够使用持续连接，默认方式下使用持续连接。

* 非持续连接

每个请求/响应对是经一个单独的 TCP 连接发送，总的响应时间是两个 RTT 加上服务器传输 HTML 文件的时间。

* 持续连接

所有的请求及响应经相同的 TCP 连接发送。

##### （2）HTTP 报文格式

* 请求报文（request）

```
GET /somedir/page.html HTTP/1.1
Host: www.someschool.edu
Connection: close
User-agent: Mozilla/5.0
Accept-language: fr
```
HTTP 请求报文的第一行叫作 **请求行** ，其后继的行叫作 **首部行** 。请求行有 3 个字段：方法字段、URL 字段、HTTP 版本字段。方法字段可以有不同的值，包括 GET、POST、HEAD、PUT 和 DELETE。

```
Host: 对象所在的主机
Connection: 要求服务器在发送完被请求的对象后就关闭这条连接
User-agent: 用户代理，向服务器发送请求的浏览器类型
Accept-language: 用户想得到该对象的法语版本
```

* 响应报文（response）

```
HTTP/1.1 200 OK
Connection: close
Data: Tue, 18 Aug 2015 15:44:03 GMT
Server: Apache/2.2.3 (CentOS)
Last-Modified: Tue, 18 Aug 2015 15:11:03 GMT
Content-Length: 6821
Content-Type: text/html

(data data data data data ...)
```
响应报文分为三部分： **状态行** 、 **首部行** 与 **实体体** 。实体体是报文的主要部分，包含了所请求的对象本身。

```
Date: 首部行指示服务器产生并发送该响应报文的时间
Server: 该报文是由一台 Apache Web 服务器产生的
Last-Modified: 对象创建或最后修改的时间和日期
Content-Length: 被发送对象中的字节数
Content-Type: 实体体对象中的对象是 HTML 文本
```

状态行有 3 个字段：协议版本字段、状态码和相应状态信息。一些常见的状态码和相关的短语包括：

| 状态码 |            短语            |                             说明                             |
| :----: | :------------------------: | :----------------------------------------------------------: |
|  200   |             OK             |               请求成功，信息在返回的响应报文中               |
|  301   |     Moved Permanently      | 请求的对象已经被永久转移了，新的 URL 定义在相应报文的 Location 首部行中。客户软件将自动获取新的 URL |
|  400   |        Bad Request         |        一个通用的差错代码，指示该请求不能被服务器理解        |
|  404   |         Not Found          |                   被请求的文档不在服务器上                   |
|  505   | HTTP Version Not Supported |           服务器不支持请求报文使用的 HTTP 协议版本           |

### 2、Cookie

HTTP 协议是无状态的，但是有一些应用需要记录用户的动作，所以引入 Cookie 。Cookie 能够用于身份认证、购物车、推荐等。

**Cookie组件**

* HTTP 响应消息的 cookie 头部行
* HTTP 请求消息的 cookie 头部行
* 保存在客户端主机上的 cookie 文件，由浏览器管理
* Web 服务器端的后台数据库

### 3、Web 缓存/代理服务器技术

Web缓存能够在不访问服务器的前提下满足客户端的 HTTP 请求，该技术能够缩短客户请求的响应时间、减少机构/组织的流量、在大范围内实现有效的内容分发。

用户设定浏览器通过缓存进行 Web 访问，浏览器向缓存/代理服务器发送所有的 HTTP 请求，如果所请求的对象在缓存中，缓存返回对象；否则，缓存服务器向原始服务器发送 HTTP 请求，获取对象，然后返回给客户端并保存该对象。

<div align="center">  <img src="./pic/Web.png" width="40%"/> </div><br>

缓存既充当客户端也充当服务器，一般由 ISP 架设。

缓存通过「条件性 GET 方法」判断缓存中的对象是否为服务器中最新的版本，如果缓存有最新的版本，则不需要发送请求对象，通过版本日期进行比较。

## Email 应用

Email 应用由邮件客户端、邮件服务器与 SMTP 协议构成。

<div align="center">  <img src="./pic/Email.png" width="80%"/> </div><br>

### 1、SMTP 协议

SMTP 协议使用 TCP 进行 email 消息的可靠传输，端口号为 25 ，采用命令/响应交互模式，只支持 ASCII 字符。

HTTP 是一个 **拉协议** ， SMTP 是一个 **推协议** 。

### 2、MIME 多媒体邮件扩展

SMTP 协议只能够传送 ASCII 字符，MIME 通过在邮件头部增加额外的行以声明 MIME 的内容类型，由此实现多媒体邮件扩展。

### 3、邮件访问协议

<div align="center">  <img src="./pic/Email2.png" width="70%"/> </div><br>

邮件发送使用 SMTP 协议，而邮件访问需要使用其他的协议。

* POP：认证/授权和下载
* IMAP：更多功能、更加复杂、能够操纵服务器上存储的消息
* HTTP：163、QQ Mail 等

## DNS 域名系统

域名系统（DNS）能够进行主机名到 IP 地址转换的目录服务。DNS 是一个由分层 DNS 服务器实现的分布式数据库，也是一个使得主机能够查询分布式数据库的应用层协议。

域名具有层次结构，从上到下依次为：根域名、顶级域名、二次域名。

<div align="center">  <img src="./pic/DNS.png" width="70%"/> </div><br>

## 远程登录

### 1、Telnet

Telnet 利用 TCP 的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。本地用户好像直接与远端主机内部的 Shell 相连着似的，直接在本地进行操作。

### 2、SSH

SSH 是加密的远程登录系统，Telnet 中登录时无需输入密码就可以发送，容易造成通信窃听和非法入侵的危险，使用 SSH 后可以加密通信内容，即使信息被窃听也无法破解所发送的密码。

# 三、传输层

## 传输层概述

### 1、传输层服务

 传输层协议为运行在不用主机上的 **进程** 提供了一种逻辑通信机制。

 * 发送方：将应用递交的消息分成一个或多个报文段，并向下传给网络层。
 * 接收方：将接收到的报文段组装成消息，并向上交给应用层。

### 2、传输层 VS 网络层

网络层提供 **主机** 之间的逻辑通信机制，而传输层提供 **应用进程** 之间的逻辑通信机制。传输层位于网络层之上，依赖于网络层服务，对网络层服务进行增强。

### 3、Internet 传输层协议

* TCP（传输控制协议）：可靠、面向连接的服务
* UDP（用户数据报协议）：不可靠、无连接服务

## 多路复用与多路分用

如果某层的一个协议对应直接上层的多个协议/实体，则需要复用/分用。类似的，网络层的一个协议对应传输层的 TCP 与 UDP 协议。

* 接收端进行多路分用：传输层依据头部信息将受到的报文段交给正确的 Socket ，即不同的进程。

* 发送端进行多路复用：从多个 Socket 接收数据，为每块数据封装上头部消息，生成报文段，交给网络层。

## UDP

运输层最低限度必须提供一种复用/分用服务，以便在网络层与正确的应用级进程之间传递数据。而 UDP 除了复用/分用功能和少量的差错检测外，几乎没有对 IP 增加别的东西。

### 1、UDP 为什么存在

* 无需建立连接（减少延迟）
* 实现简单：无需维护连接状态
* 头部开销少
* 没有拥塞控制：应用可以更好地控制发送时间和速率

### 2、UDP 报文结构

UDP 首部只有 4 个字段，每个字段由两个字节组成：源端口号、目的端口号、长度和校验和。

<div align="center">  <img src="./pic/UDP.png" width="70%"/> </div><br>

### 3、UDP 校验和

UDP 校验和提供差错检测功能。发送方的 UDP 对报文段中的所有 16 比特字的和进行反码运算，求和时遇到任何溢出都被回卷。得到的结果被放到 UDP 报文段中的校验和字段。

**为什么 UDP 提供了校验和？**

不能保证源和目的之间的所有链路都提供差错检测。

## 可靠数据传输原理

在实际的网络传输中，信道是不可靠的，在其上传输的数据分组可能丢失、损坏或者失序，因此需要一个可靠的数据传输协议，来保证从发送端发送的数据能够按序无损地交付给接收端。在传输层中，通过可靠数据传输协议，在不可靠的网络层信道上，实现了数据的可靠传输。

### 1、经完全可靠信道的可靠数据传输 rdt 1.0

假设信道完全可靠，从发送端发送的数据会按序、无损、不丢失的交付到接收端。

### 2、经具有比特差错信道的可靠数据传输 rdt 2.0

底层信道更为实际的模型是分组中的比特可能受损，假定即时数组受损，分组也会不丢失地到达接收端。

在这种情况下，由于信道会造成数据差错，为了使分组能无差错、按序传输，则需要：

* **差错检测：** 接收端需要检测出数据在哪里出错了，比如在分组首部中加入校验和字段。
* **接收方反馈：** 接收端要告诉发送端，某个分组的数据在传输过程中出错了。数据没错就发送 ACK (肯定确认)，数据错了就发送 NAK (否定确认)。
* **重传：** 接收方收到有差错的分组时，发送方将重传该分组。

**如果 ACK 或 NAK 分组受损呢？（rdt 2.1）**

发送方遇到受损反馈分组时，一律重传；在接收端判断该分组是否已经接受成功（通过添加新字段，0 1 交替编号进行判断，编号与上一个分组编号相同则为重传分组）。

**舍弃 NAK (rdt 2.2)**

NAK 只在接受端遇到受损分组时发送，其实我们可以舍弃 NAK 。利用分组的编号，在遇到受损分组时，发送 ACK ，并附带上一次成功接受的分组对应的序号。发送端接受 ACK 后，将其序号与当前要发送的分组序号相比，就知道要重传还是发送新的分组了。

### 3、经具有比特差错的丢包信道的可靠数据传输 rdt 3.0

在实际情况中，发送方发送的分组可能会丢失（比如被路由器丢弃）.

当分组丢失时，发送方会一直等待接收方的反馈信息，而接收方也会一直等待新的分组到来，这样以来，系统就没办法工作了。因此，我们可以在发送方设置一个定时器，估计一下发送方与接收方之间数据的往返时延，每当发送一个分组时，就启动定时器，若超过预定的时间值，发送方则重传分组。对于发送方，不知道是发送的数据丢失还是ACK丢失，那么重传就是万能灵药了；对于接收方，不管数据有没有丢失，收到冗余分组时丢弃即可。

### 4、流水线可靠数据传输协议

从rdt 1.0 一步步演变到 rdt 3.0, 已经实现了一个经具有比特差错的丢包信道的可靠数据传输协议，此协议已经可以在现实生活中真实的信道上面运行了。然而由于该协议是停等协议，也就是必须成功接收到接收方的反馈信息，才能传递下一个分组（不论是传递新分组还是重传）。这样虽然能很好地保证分组能按序到达接收端，但是数据传输效率十分低下，每次传输都至少要等待一个往返时延（Round-Trip Time）。那么怎么才能加快传输速率呢？

可以使用流水线技术，也就是发送端可以同时发送多个分组到信道中，不需要依次等待上一个分组确认到达之后再发送下一个分组。通过 **退回 N 步(Go Back N)** 和 **选择重传 (Selective Repeat)** 处理数据的丢失、损坏、失序和超时到达。

* 退回 N 步（GBN）：接收端采用累积确认避免失序，发送端维护发送窗口，只使用一个定时器，超时则全部重传未确认分组。
* 选择重传（SR）：发送端、接收端分别维护一个窗口；每个分组都有一个独立的定时器，单个确认。

## TCP

TCP 通过校验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

<div align="center">  <img src="./pic/TCP0.png" width="60%"/> </div><br>

* 序列号：发送数据的位置，每发送一次数据，就累加一次该数据字节数的大小。
* 确认应答号：下一次应该受到的数据的序列号。实际上，它是指已受到确认应答号减一为止的数据。发送端受到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。
* 数据偏移：TCP 所传输的数据部分应该从 TCP 包的哪个位置开始计算，也可以把它看作 TCP 首部的长度。
* 保留：为了以后扩展时使用，一般设置为 0 。
* 控制位：字段长为 8 位，每一位从左至右分别为 CWR、ECE、URG、ACK、PSH、RST、SYN、FIN。
* 窗口大小：用于通知从相同 TCP 首部的确认应答号所指位置开始能够接收的数据大小，TCP 不允许发送超过此处所示大小的数据。
* 校验和：与 UDP 相似，区别在于 TCP 的校验和无法关闭。
* 紧急指针：只有在 URG 控制位为 1 时有效，该字段的数值表示本报文段中紧急数据的指针。
* 选项：用于提高 TCP 的传输性能。

## TCP 流量控制

一般来说，总是希望数据传输得更快一些。但如果发送方把数据发送得过快，接收方就可能来不及接收，这就回造成数据的丢失。所谓流量控制就是让发送方发送的速率不要太快，要让接收方来得及接收。

利用滑动窗口机制可以方便地在 TCP 连接上实现对发送方的流量控制。发送方的发送窗口不能超过接收方给出的接收窗口的数值。

## TCP 连接管理

### 1、建立连接
<div align="center">  <img src="./pic/TCP1.png" width="60%"/> </div><br>

### 2、释放连接
<div align="center">  <img src="./pic/TCP2.png" width="60%"/> </div><br>

## TCP 拥塞控制

在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种情况就交拥塞。

TCP 进行拥塞控制的算法有四种，分别为 **慢开始** 、 **拥塞避免** 、 **快重传** 与 **快恢复** 。

<div align="center">  <img src="./pic/TCP3.png" width="70%"/> </div><br>

### 1、慢开始

当主机开始发送数据时，由于并不清楚网络的负荷情况，所以如果立即把大量数据字节注入到网络，那么久有可能引起网络发生拥塞。经验证明，较好的方法是先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。

### 2、拥塞避免

为了防止拥塞窗口增长过大引起网络拥塞，还需要设置一个慢开始门限状态变量。当拥塞窗口超过慢开始门限后，使用拥塞避免，让拥塞窗口缓慢地增大，即没经过一个往返时间 RTT 就把发送方的拥塞窗口加 1，而不是像慢开始阶段那样加倍增长。

### 3、快重传

快重传可以让发送方尽早知道发生了个别报文段的丢失。该算法要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认，发送方只要一连收到 3 个重复确认，就知道接收方确实没有收到报文，应该立即进行重传。

### 4、快恢复

快重传后，发送方知道现在只是丢失了个别的报文段，于是不启动慢开始，而是执行快恢复算法，将发送方调整门限值为 ssthresh = cwnd / 2，同时设置拥塞窗口 cwnd = ssthresh，并开始执行拥塞避免算法。

# 网络层

## 网络层概述

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据包服务，网络层不提供服务质量的承诺。

网络层负责从发送主机向接收主机传送数据段，每个主机和路由器都运行网络层协议。

* 发送主机：将数据段封装到数据报中
* 接收主机：向传输层交付数据段

网络层核心功能：

* 转发：将分组层路由器的输入端口转移到合适的输出端口
* 路由：确定分组从源到目的经过的路径

## IP 协议

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一，是最重要的互联网标准协议之一。

与 IP 协议配套使用的协议：

* 地址解析协议 ARP
* 网际控制报文协议 ICMP
* 网际组管理协议 IGMP

### 1、IP 报文结构

<div align="center">  <img src="./pic/IP.png" width="60%"/> </div><br>

 * 版本号：IP 首部的版本号， IPV4 版本号为 4 ， IPV6 版本号为 6。
 * 首部长度：IP 首部的大小，单位为 4 字节，对于没有选项的 IP 包，首部长度设置为 5 。
 * 区分服务：指示期望获得哪种类型的服务，只有在网络提供区分服务时才使用。
 * 总长度：IP 首部与数据部分合起来的总字节数。
 * 标识：用于分片重组，同一个分片的标示值相同，不同分片的标示值不同。
 * 标志位：包被分片的相关信息。
 * 片偏移：用来标识被分片的每个分段相对于原始数据的位置。
 * 生存时间：IP 分组在网络中可以通过的路由器数。
 * 协议：IP 分组封装的是哪个协议的数据包。
 * 首部校验和：实现对 IP 分组首部的差错检测。
 * 选项：通常只在进行实验或诊断时使用。
 * 填充：首部长度可能不是 32 比特的整数倍，为此，通过向字段填充 0 ，调整为 32 比特的整数倍。

### 2、IP 分片与重组

**最大传输单元（MTU）：** 链路层数据帧可封装数据的上限，不同链路的 MTU 不同。

大 IP 分组向较小 MTU 链路转发时，**可以** 被分片，1 个 IP 分组分为多片 IP 分组，IP 分片到达目的主机后进行重组。通常分片时，除最后一个分片，其他分片均为 MTU 允许的最大分片。

IP 首部的相关字段用标识分片以及确定分片的相对顺序（标识、标志位、片偏移）。

### 3、IP 编址

**IP 地址：** 32比特（IPv4），编号标识主机、路由器的接口。高位比特位网络号（NetID），低比特位为主机号（HostID）。

**点分十进制**
<div align="center">  <img src="./pic/IP1.png" width="40%"/> </div><br>

**IP 子网**

IP 地址具有相同的网络号的设备接口，不跨越路由器（第三级以上网络设备）可以彼此物理联通的接口。

<div align="center">  <img src="./pic/IP2.png" width="40%"/> </div><br>

**有类编址**

<div align="center">  <img src="./pic/IP3.png" width="70%"/> </div><br>

**特殊 IP 地址**

<div align="center">  <img src="./pic/IP4.png" width="50%"/> </div><br>

**私有 IP 地址**

只用于内部网络。

<div align="center">  <img src="./pic/IP5.png" width="40%"/> </div><br>

## 子网划分

划分子网的方法是从网络的主机借用若干位作为子网号，主机号也就减少了同样的位数，于是两级 IP 地址在本单位内部就变为三级 IP 地址：网络号、子网号和主机号。

### 1. 子网掩码

网络号与子网号全取 1 ，主机号取 0 ，将 IP 分组的目的 IP 地址与子网掩码按位与运算，提取子网地址。

例如：
* A 网的默认子网掩码为：255.0.0.0
* B 网的默认子网掩码为：255.255.0.0
* 借用 3 比特划分子网的 B 网的子网掩码为：255.255.224.0

### 2. CIDR 与路由聚合

无类域间路由（CIDR）：
* 消除传统的 A 类、B 类和 C 类地址界限
* 融合子网地址与子网掩码，方便子网划分

**无类地址格式：** `a.b.c.d/x`，x 为前缀长度。

<div align="center">  <img src="./pic/CIDR.png" width="60%"/> </div><br>

**优点**

* 提高 IPv4 地址空间分配效率
* 提高路由效率：将多个子网聚合为一个较大的子网，构造超网，即「路由聚合」。

**最长前缀匹配**

在使用 CIDR 时，由于采用了网络前缀这种记法， IP 地址由网络前缀和主机号这两个部分组成，查找路由表时可能会得到不止一个匹配结果，这时应该从匹配结果中选择具有最长网络前缀的路由。

## DHCP 协议

逐一为每一台主机设置 IP 地址会非常繁琐，所以，为了实现自动设置 IP 地址、统一管理 IP 地址分配，就产生了 DHCP 协议。有了 DHCP，计算机只要连接到网络，就可以进行 TCP/IP 通信。

## NAT 网络地址转换

NAT 是用于在本地网络中使用私有地址，在连接互联网时转而使用全局 IP 地址的技术。

### 1. 优点

* 只需从 ISP 申请一个 IP 地址（IPv4 地址耗尽）
* 本地网络设备 IP 地址的变更，无需通告外界网络
* 变更 ISP 时，无需修改内部网络设备 IP 地址
* 内部网络设备对外界网络不可见，即不可直接寻址（安全）

### 2. 实现

* 替换1：利用（NAT IP 地址，新端口号）替换每个外出 IP 数据包的（源 IP 地址，源端口号）
* 记录：将没对（NAT IP 地址，新端口号）与（源 IP 地址，源端口号）的替换信息存储到 NAT 转换表中
* 替换2：根据 NAT 转换表，利用（源 IP 地址，源端口号）替换每个进入内网 IP 数据报的（目的 IP 地址，目的端口号），即（NAT IP 地址，新端口号）

16-bit 端口号字段可以同时支持 60000 多并行连接

### 3. 争议

* 路由器应该只处理第三层功能
* 违背端到端通信原则
* 地址短缺问题应该由 IPv6 来解决

### 4、NAT 穿透（穿越）

外部客户如何访问 NAT 内部的主机？这就是 NAT 穿透解决的问题，有以下三种方法：

* 静态配置 NAT ,将特定端口的连接请求转发给服务器
* 利用 UPnP 互联网网关设备协议自动配置
* 与中继服务器建立连接





# 参考内容

* 詹姆斯·F.库罗斯. 计算机网络: 自顶向下方法（原书第7版）[M]. 机械工业出版社, 2018.
* 谢仁希. 计算机网络（第七版）[M]. 电子工业出版社, 2017.
* 竹下隆史. 图解TCP/IP（第5版）[M]. 人民邮电出版社, 2013.
* [可靠数据传输原理](https://yieldnull.com/blog/943b65e3a64843303b8f15e1acbf79a77ace947f/)